<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Family Tree Viewer</title>
    <meta name="description" content="Interactive, zoomable family tree" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand-group">
        <div class="brand" id="treeName">Loading...</div>
      </div>
      <div class="controls">
        <button id="themeBtn" title="Switch theme" aria-label="Switch theme">
          <span class="material-symbols-outlined" aria-hidden="true">light_mode</span>
        </button>
        <button id="searchBtn" title="Search people" aria-label="Search people">
          <span class="material-symbols-outlined" aria-hidden="true">search</span>
        </button>
        <button id="dnaBtn" title="Toggle lineage lines" aria-label="Toggle lineage lines">Show Lines</button>
        <button id="zoomInBtn" title="Zoom in" aria-label="Zoom in">+</button>
        <button id="zoomOutBtn" title="Zoom out" aria-label="Zoom out">-</button>
        <button id="resetBtn" title="Reset position" aria-label="Reset tree view">Reset</button>
        <button id="focusBtn" title="Enter focus mode" aria-pressed="false" aria-label="Enter focus mode">Focus</button>
        <button id="helpBtn" title="Help" aria-label="Help and shortcuts">
          <span class="material-symbols-outlined" aria-hidden="true">help</span>
        </button>
        <button id="backBtn" title="Back" aria-label="Back to dashboard" style="margin-left: 8px;">
          <span class="material-symbols-outlined" aria-hidden="true">home</span>
        </button>
      </div>
    </header>

    <div id="upcomingBanner" class="upcoming-banner" hidden aria-live="polite"></div>

    <div class="view-toggle" role="group" aria-label="Switch view">
      <button class="view-toggle-btn is-active" type="button" data-view="tree" aria-pressed="true">
        <span class="material-symbols-outlined tree-icon" aria-hidden="true">account_tree</span>
        <span class="view-label">Tree</span>
      </button>
      <button class="view-toggle-btn" type="button" data-view="globe" aria-pressed="false">
        <span class="material-symbols-outlined" aria-hidden="true">public</span>
        <span class="view-label">Globe</span>
      </button>
    </div>

    <!-- Search Bar -->
    <div id="searchBar" class="search-bar">
      <input type="text" id="searchInput" placeholder="Search for a person..." aria-label="Search for a person" />
      <button id="searchClearBtn" aria-label="Close search">âœ•</button>
      <div id="searchResults" class="search-results"></div>
    </div>

    <main class="page">
      <div class="canvas-wrap">
        <!-- The SVG holds the zoom/pan surface -->
        <svg id="tree" tabindex="0" aria-label="Family tree canvas" role="img"></svg>
      </div>
    </main>

    <section id="globeView" class="globe-view" aria-hidden="true">
      <div class="globe-panel">
        <div class="globe-stage">
          <svg id="globeSvg" role="img" aria-label="Globe view"></svg>
          <div id="globeTooltip" class="globe-tooltip" hidden></div>
        </div>
        <div class="globe-legend" aria-hidden="true">
          <span class="legend-item"><span class="legend-dot legend-home"></span>Home country</span>
          <span class="legend-item"><span class="legend-dot legend-moved"></span>Moved permanently</span>
          <span class="legend-item"><span class="legend-dot legend-visited"></span>Visited</span>
        </div>
      </div>
    </section>

    <section id="birthdaySection" class="birthday-bar" aria-label="Family birthdays by month">
      <div class="calendar-side-nav" aria-hidden="true">
        <button id="calendarSidePrev" class="month-nav-btn" type="button" aria-label="Previous month">&lt;</button>
        <button id="calendarSideNext" class="month-nav-btn" type="button" aria-label="Next month">&gt;</button>
      </div>
      <div id="birthdayMonths" class="birthday-months" aria-live="polite"></div>
    </section>

    <div id="birthdayTooltip" class="birthday-tooltip" role="status" aria-live="polite" hidden></div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
      <div class="modal-dialog">
        <button id="modalClose" class="modal-close" aria-label="Close">&times;</button>
        <img id="modalImg" class="modal-img" alt="Selected person photo" />
        <div class="modal-meta">
          <div id="modalTitle" class="modal-name"></div>
          <div id="modalDob" class="modal-dob"></div>
          <div id="modalExtendedInfo"></div>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="help-modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle" aria-hidden="true">
      <div class="help-modal-dialog">
        <button id="helpClose" class="modal-close" aria-label="Close">&times;</button>
        <h2 id="helpTitle">Help &amp; Shortcuts</h2>

        <h3>Statistics</h3>
        <p class="stats-note">From the perspective of the root couple.</p>
        <div class="shortcut-grid stats-grid">
          <span class="shortcut-key">Children = <span id="statsKids">-</span></span>
          <span class="shortcut-key">Grandchildren = <span id="statsGrandkids">-</span></span>
          <span class="shortcut-key">Great-grandchildren = <span id="statsGreatGrandkids">-</span></span>
        </div>

        <h3>Navigation</h3>
        <div class="shortcut-grid">
          <span class="shortcut-key">Mouse wheel</span>
          <span class="shortcut-desc">Zoom in/out</span>
          <span class="shortcut-key">Click + Drag</span>
          <span class="shortcut-desc">Move view</span>
          <span class="shortcut-key">+</span>
          <span class="shortcut-desc">Zoom in</span>
          <span class="shortcut-key">-</span>
          <span class="shortcut-desc">Zoom out</span>
          <span class="shortcut-key">R</span>
          <span class="shortcut-desc">Reset view</span>
        </div>

        <h3>Actions</h3>
        <div class="shortcut-grid">
          <span class="shortcut-key">Esc</span>
          <span class="shortcut-desc">Exit focus / Close</span>
          <span class="shortcut-key">F</span>
          <span class="shortcut-desc">Focus mode</span>
          <span class="shortcut-key">L</span>
          <span class="shortcut-desc">Lineage lines</span>
          <span class="shortcut-key">T</span>
          <span class="shortcut-desc">Switch theme (light/dark)</span>
          <span class="shortcut-key">S or /</span>
          <span class="shortcut-desc">Open search</span>
          <span class="shortcut-key">C</span>
          <span class="shortcut-desc">Calendar</span>
          <span class="shortcut-key">?</span>
          <span class="shortcut-desc">Show this help</span>
        </div>

        <h3>Functions</h3>
        <p><strong>Click on a person</strong> to see details and relationships.</p>
        <p><strong>Search</strong> any family member by name.</p>
        <p><strong>Calendar</strong> shows all birthdays organized by month.</p>
      </div>
    </div>

    <noscript>
      This page requires JavaScript to render the family tree.
    </noscript>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- D3 for layout + zoom -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script src="firebase-config.js"></script>
    
    <!-- Load tree viewer before main script -->
    <script>
      // This script loads the tree data from Firebase before script.js runs
      window.FIREBASE_TREE_DATA = null;
      window.FIREBASE_TREE_NAME = null;
      
      (async function() {
        // Initialize Firebase
        if (typeof initializeFirebase === 'function') {
          initializeFirebase();
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const treeId = urlParams.get('id');
        
        if (!treeId) {
          document.getElementById('treeName').textContent = 'No tree specified';
          alert('No tree ID provided in URL');
          return;
        }
        
        try {
          const doc = await firebase.firestore().collection('trees').doc(treeId).get();
          
          if (!doc.exists) {
            document.getElementById('treeName').textContent = 'Tree not found';
            alert('Tree not found');
            return;
          }
          
          const tree = doc.data();
          
          // Check privacy
          const currentUser = firebase.auth().currentUser;
          if (tree.privacy === 'private' && (!currentUser || currentUser.uid !== tree.userId)) {
            document.getElementById('treeName').textContent = 'Private tree';
            alert('This tree is private');
            return;
          }
          
          // Set global variables for script.js to use
          window.FIREBASE_TREE_DATA = tree.data;
          window.FIREBASE_TREE_NAME = tree.name;
          document.getElementById('treeName').textContent = tree.name;
          
        } catch (error) {
          console.error('Error loading tree:', error);
          document.getElementById('treeName').textContent = 'Error loading tree';
          alert('Error loading tree: ' + error.message);
        }
      })();
      
      // Back button handler
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('backBtn')?.addEventListener('click', () => {
          // Check if user is logged in
          if (firebase.auth().currentUser) {
            window.location.href = 'dashboard.html';
          } else {
            window.location.href = 'auth.html';
          }
        });
      });
    </script>
    
    <script src="script.js"></script>
    <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="paulsuatean" data-description="Support me on Buy me a coffee!" data-message="Buy me a coffee?" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script>
  </body>
</html>
